---
title: "Raster Polygonizer Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Raster Polygonizer Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(rasterpolygonizer)

if (!requireNamespace("sf", quietly = TRUE)) stop("Install 'sf' to run this vignette")
if (!requireNamespace("terra", quietly = TRUE)) stop("Install 'terra' to run this vignette")
#if (!requireNamespace("rmapshaper", quietly = TRUE)) stop("Install 'rmapshaper' to run this vignette")


```

```{r message=FALSE, warning=FALSE}
library(ggplot2)


r_path <- system.file("extdata", "sample_raster.tif", package = "rasterpolygonizer")
stopifnot(nzchar(r_path))

r <- terra::rast(r_path)

r_df_raw <- as.data.frame(r, xy = TRUE, na.rm = TRUE)
names(r_df_raw)[3] <- "value"

ggplot(r_df_raw) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  coord_equal() +
  scale_fill_viridis_c(na.value = "transparent") +
  theme_minimal() +
  labs(title = "Input raster")

r_filled <- fill_ground_raster(r)

r_df_filled <- as.data.frame(r_filled, xy = TRUE, na.rm = TRUE)
names(r_df_filled)[3] <- "value"

ggplot(r_df_filled) +
  geom_raster(aes(x = x, y = y, fill = value)) +
  coord_equal() +
  scale_fill_viridis_c(na.value = "transparent") +
  theme_minimal() +
  labs(title = "Filled ground raster")

edges <- extract_building_edges_to_polygons(r_filled, thr_prob = .75)

# Use raster extent as mask for this example
mask_poly <- terra::as.polygons(r)
mask_sf <- sf::st_as_sf(mask_poly)

buildings_sf <- clean_building_polygons(
  closed_edges = edges$closed_edges,
  shrink_dist = -0.5,
  simplify_tol = 2.5,
  min_area = 19.99,
  max_area = 2000
)

# Print summary



r_df <- as.data.frame(r_filled, xy = TRUE, na.rm = TRUE)
names(r_df)[3] <- "value"
ggplot() +
  geom_raster(
    data = r_df,
    aes(x = x, y = y, fill = value)
  ) +
  geom_sf(
    data = buildings_sf,
    fill = NA,
    color = "red",
    linewidth = 0.6
  ) +
  coord_sf() +
  scale_fill_viridis_c(na.value = "transparent") +
  theme_minimal()

```

